<div class="manager-dashboard">
  <!-- Header Toolbar -->
  <mat-toolbar color="primary" class="dashboard-header">
    <mat-icon>supervisor_account</mat-icon>
    <span class="toolbar-title">Manager Dashboard</span>
    <span class="toolbar-spacer"></span>
    <button mat-icon-button (click)="logout()" matTooltip="Logout">
      <mat-icon>logout</mat-icon>
    </button>
  </mat-toolbar>

  <!-- Success/Error Messages -->
  <div class="messages-container" *ngIf="successMessage || errorMessage">
    <mat-card *ngIf="successMessage" class="success-message">
      <mat-card-content>
        <mat-icon>check_circle</mat-icon>
        {{ successMessage }}
      </mat-card-content>
    </mat-card>
    <mat-card *ngIf="errorMessage" class="error-message">
      <mat-card-content>
        <mat-icon>error</mat-icon>
        {{ errorMessage }}
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Main Content with Tabs -->
  <mat-tab-group [(selectedIndex)]="selectedTabIndex" (selectedTabChange)="onTabChange($event.index)" class="main-tabs">
    
    <!-- Work Orders Tab -->
    <mat-tab label="Work Orders">
      <ng-template matTabContent>
        <div class="tab-content">
          <div class="content-grid">
            
            <!-- Create Work Order Section -->
            <mat-card class="create-order-card">
              <mat-card-header>
                <mat-card-title>
                  <mat-icon>add_circle</mat-icon>
                  Create New Work Order
                </mat-card-title>
              </mat-card-header>
              
              <mat-card-content>
                <form [formGroup]="createOrderForm" (ngSubmit)="onSubmitOrder()">
                  
                  <!-- Basic Information -->
                  <div class="form-section">
                    <h3>Basic Information</h3>
                    <div class="form-row">
                      <mat-form-field appearance="outline">
                        <mat-label>Party Name *</mat-label>
                        <input matInput formControlName="partyName" placeholder="Enter party name">
                        <mat-error *ngIf="createOrderForm.get('partyName')?.hasError('required')">
                          Party name is required
                        </mat-error>
                        <mat-error *ngIf="createOrderForm.get('partyName')?.hasError('minlength')">
                          Minimum 2 characters required
                        </mat-error>
                      </mat-form-field>

                      <mat-form-field appearance="outline">
                        <mat-label>P.O. Number</mat-label>
                        <input matInput formControlName="poNumber" placeholder="Enter PO number">
                      </mat-form-field>
                    </div>

                    <div class="form-row">
                      <mat-form-field appearance="outline">
                        <mat-label>P.O. Date</mat-label>
                        <input matInput [matDatepicker]="poDatePicker" formControlName="poDate">
                        <mat-datepicker-toggle matSuffix [for]="poDatePicker"></mat-datepicker-toggle>
                        <mat-datepicker #poDatePicker></mat-datepicker>
                      </mat-form-field>

                      <mat-form-field appearance="outline">
                        <mat-label>Expected Completion</mat-label>
                        <input matInput [matDatepicker]="completionDatePicker" formControlName="expectedCompletionDate">
                        <mat-datepicker-toggle matSuffix [for]="completionDatePicker"></mat-datepicker-toggle>
                        <mat-datepicker #completionDatePicker></mat-datepicker>
                      </mat-form-field>
                    </div>

                    <div class="form-row">
                      <mat-form-field appearance="outline">
                        <mat-label>Item Details *</mat-label>
                        <input matInput formControlName="itemDetails" placeholder="e.g., Gold Ring Set">
                        <mat-error *ngIf="createOrderForm.get('itemDetails')?.hasError('required')">
                          Item details are required
                        </mat-error>
                      </mat-form-field>

                      <mat-form-field appearance="outline">
                        <mat-label>Model Number</mat-label>
                        <input matInput formControlName="modelNumber" placeholder="Enter model number">
                      </mat-form-field>
                    </div>

                    <div class="form-row">
                      <mat-form-field appearance="outline">
                        <mat-label>Gross Weight (g)</mat-label>
                        <input matInput type="number" formControlName="grossWeight" step="0.01">
                      </mat-form-field>

                      <mat-form-field appearance="outline">
                        <mat-label>Net Weight (g)</mat-label>
                        <input matInput type="number" formControlName="netWeight" step="0.01">
                      </mat-form-field>
                    </div>

                    <mat-form-field appearance="outline" class="full-width">
                      <mat-label>Description of Work</mat-label>
                      <textarea matInput formControlName="descriptionOfWork" rows="3" placeholder="Describe the work to be done..."></textarea>
                    </mat-form-field>
                  </div>

                  <!-- Stones Section -->
                  <div class="form-section">
                    <div class="section-header">
                      <h3>
                        <mat-icon>diamond</mat-icon>
                        Stones Information
                      </h3>
                      <button mat-raised-button color="primary" type="button" (click)="addStoneRow()">
                        <mat-icon>add</mat-icon>
                        Add Stone
                      </button>
                    </div>

                    <div formArrayName="stones" class="stones-container">
                      <mat-card *ngFor="let stone of stones.controls; let i = index" [formGroupName]="i" class="stone-card">
                        <mat-card-content>
                          <div class="stone-form-row">
                            <mat-form-field appearance="outline">
                              <mat-label>Type *</mat-label>
                              <input matInput formControlName="type" placeholder="e.g., Ruby, CZ">
                            </mat-form-field>

                            <mat-form-field appearance="outline">
                              <mat-label>Pieces *</mat-label>
                              <input matInput type="number" formControlName="pieces" min="1">
                            </mat-form-field>

                            <mat-form-field appearance="outline">
                              <mat-label>Weight (g) *</mat-label>
                              <input matInput type="number" formControlName="weightGrams" step="0.001" min="0.001" 
                                     (input)="onWeightGramsChange(i, $event)"
                                     [value]="formatWeight(stone.get('weightGrams')?.value)">
                              <mat-hint>Auto-converts to carats (ร5)</mat-hint>
                            </mat-form-field>

                            <mat-form-field appearance="outline">
                              <mat-label>Weight (ct) *</mat-label>
                              <input matInput type="number" formControlName="weightCarats" step="0.001" min="0.001"
                                     (input)="onWeightCaratsChange(i, $event)"
                                     [value]="formatWeight(stone.get('weightCarats')?.value)">
                              <mat-hint>Auto-converts to grams (รท5)</mat-hint>
                            </mat-form-field>

                            <button mat-icon-button color="warn" type="button" (click)="removeStoneRow(i)" [disabled]="stones.length === 1">
                              <mat-icon>delete</mat-icon>
                            </button>
                          </div>
                        </mat-card-content>
                      </mat-card>
                    </div>
                  </div>

                  <!-- Worker Assignment Section -->
                  <div class="form-section">
                    <div class="section-header">
                      <h3>
                        <mat-icon>group</mat-icon>
                        Assign Workers (Optional)
                      </h3>
                      <button mat-raised-button color="primary" type="button" (click)="addWorkerAssignment()">
                        <mat-icon>add</mat-icon>
                        Add Assignment
                      </button>
                    </div>

                    <div formArrayName="assignedWorkers" class="workers-container">
                      <mat-card *ngFor="let worker of assignedWorkers.controls; let i = index" [formGroupName]="i" class="worker-card">
                        <mat-card-content>
                          <div class="worker-form-row">
                            <mat-form-field appearance="outline">
                              <mat-label>Stage</mat-label>
                              <mat-select formControlName="stageType">
                                <mat-option *ngFor="let stage of stageTypes" [value]="stage">
                                  {{ stage | titlecase }}
                                </mat-option>
                              </mat-select>
                            </mat-form-field>

                            <mat-form-field appearance="outline">
                              <mat-label>Worker</mat-label>
                              <mat-select formControlName="workerId" (selectionChange)="onWorkerChange(i)">
                                <mat-option *ngFor="let w of getWorkersByStage(worker.get('stageType')?.value)" [value]="w.id">
                                  {{ w.name }}
                                </mat-option>
                              </mat-select>
                            </mat-form-field>

                            <button mat-icon-button color="warn" type="button" (click)="removeWorkerAssignment(i)">
                              <mat-icon>delete</mat-icon>
                            </button>
                          </div>
                        </mat-card-content>
                      </mat-card>
                    </div>
                  </div>

                  <!-- Submit Button -->
                  <div class="form-actions">
                    <button mat-raised-button color="primary" type="submit" [disabled]="submitting || createOrderForm.invalid" class="submit-button">
                      <mat-spinner *ngIf="submitting" diameter="20"></mat-spinner>
                      <mat-icon *ngIf="!submitting">save</mat-icon>
                      {{ submitting ? 'Creating...' : 'Create Work Order' }}
                    </button>
                  </div>
                </form>
              </mat-card-content>
            </mat-card>

            <!-- Work Orders List -->
            <mat-card class="orders-list-card">
              <mat-card-header>
                <mat-card-title>
                  <mat-icon>list_alt</mat-icon>
                  Work Orders
                </mat-card-title>
              </mat-card-header>
              
              <mat-card-content>
                <div *ngIf="loading" class="loading-container">
                  <mat-spinner></mat-spinner>
                </div>
                
                <div *ngIf="!loading && workOrders.length === 0" class="empty-state">
                  <mat-icon>inbox</mat-icon>
                  <p>No work orders found</p>
                </div>

                <div *ngIf="!loading && workOrders.length > 0" class="orders-list">
                  <mat-card *ngFor="let order of workOrders" class="order-item">
                    <mat-card-header>
                      <mat-card-title>{{ order.workOrderNumber }}</mat-card-title>
                      <mat-card-subtitle>{{ order.partyName }} โข {{ formatDate(order.createdDate) }}</mat-card-subtitle>
                    </mat-card-header>
                    
                    <mat-card-content>
                      <p>{{ order.itemDetails }}</p>
                      <div class="order-status">
                        <mat-chip-set>
                          <mat-chip [class]="getStatusBadgeClass(order.status)">
                            {{ order.status | titlecase }}
                          </mat-chip>
                        </mat-chip-set>
                        <div class="progress-info">
                          <mat-progress-bar mode="determinate" [value]="calculateProgress(order)"></mat-progress-bar>
                          <span>{{ calculateProgress(order) }}%</span>
                        </div>
                      </div>
                    </mat-card-content>
                    
                    <mat-card-actions>
                      <button mat-button color="primary" (click)="openAssignmentModal(order)">
                        <mat-icon>person_add</mat-icon>
                        Assign Workers
                      </button>
                    </mat-card-actions>
                  </mat-card>
                </div>
              </mat-card-content>
            </mat-card>
          </div>
        </div>
      </ng-template>
    </mat-tab>

    <!-- Stage Tabs -->
    <mat-tab *ngFor="let stage of stageTypes" [label]="stage | titlecase">
      <ng-template matTabContent>
        <div class="stage-content">
          <mat-toolbar class="stage-toolbar">
            <mat-icon>{{ stageIcons[stage] }}</mat-icon>
            <span>{{ stage | titlecase }} Management</span>
            <span class="toolbar-spacer"></span>
            <mat-chip-set>
              <mat-chip>{{ (stageWorkOrders[stage] || []).length }} Orders</mat-chip>
            </mat-chip-set>
          </mat-toolbar>

          <div class="stage-orders-grid">
            <mat-card *ngFor="let order of stageWorkOrders[stage]" class="stage-order-card">
              <mat-card-header>
                <mat-card-title>{{ order.workOrderNumber }}</mat-card-title>
                <mat-card-subtitle>{{ order.partyName }}</mat-card-subtitle>
              </mat-card-header>
              
              <mat-card-content>
                <div class="order-details">
                  <div class="detail-row">
                    <span class="label">Product:</span>
                    <span>{{ order.productType }}</span>
                  </div>
                  <div class="detail-row">
                    <span class="label">Issue Weight:</span>
                    <span>{{ order.issueWeight }}g</span>
                  </div>
                  <div class="detail-row" *ngIf="order.jamahWeight">
                    <span class="label">Jamah Weight:</span>
                    <span>{{ order.jamahWeight }}g</span>
                  </div>
                  <div class="detail-row">
                    <span class="label">Status:</span>
                    <mat-chip [class]="getStatusBadgeClass(order.status)">
                      {{ order.status | titlecase }}
                    </mat-chip>
                  </div>
                  <div class="detail-row" *ngIf="order.notes">
                    <span class="label">Notes:</span>
                    <span>{{ order.notes }}</span>
                  </div>
                </div>
              </mat-card-content>
              
              <mat-card-actions>
                <button mat-raised-button color="primary" (click)="openStageUpdateModal(order, stage)">
                  <mat-icon>edit</mat-icon>
                  Update Status
                </button>
              </mat-card-actions>
            </mat-card>
          </div>

          <div *ngIf="!stageWorkOrders[stage] || stageWorkOrders[stage].length === 0" class="empty-stage">
            <mat-icon>work_off</mat-icon>
            <p>No orders assigned to {{ stage | titlecase }}</p>
          </div>
        </div>
      </ng-template>
    </mat-tab>
  </mat-tab-group>
</div>

<!-- Worker Assignment Modal -->
<ng-container *ngIf="selectedOrderForAssignment">
  <div class="modal-overlay" (click)="closeAssignmentModal()">
    <mat-card class="assignment-modal" (click)="$event.stopPropagation()">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>person_add</mat-icon>
          Assign Workers - {{ selectedOrderForAssignment.workOrderNumber }}
        </mat-card-title>
      </mat-card-header>
      
      <mat-card-content>
        <form [formGroup]="assignmentForm">
          <div formArrayName="assignments">
            <mat-card *ngFor="let assignment of assignments.controls; let i = index" [formGroupName]="i" class="assignment-card">
              <mat-card-content>
                <div class="assignment-row">
                  <mat-form-field appearance="outline">
                    <mat-label>Stage</mat-label>
                    <input matInput formControlName="stageType" readonly [value]="assignment.get('stageType')?.value | titlecase">
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Assign Worker</mat-label>
                    <mat-select formControlName="workerId" (selectionChange)="onAssignmentWorkerChange(i)">
                      <mat-option value="">Select Worker</mat-option>
                      <mat-option *ngFor="let worker of getWorkersByStage(assignment.get('stageType')?.value)" [value]="worker.id">
                        {{ worker.name }} ({{ worker.email }})
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>
              </mat-card-content>
            </mat-card>
          </div>
        </form>
      </mat-card-content>
      
      <mat-card-actions>
        <button mat-button (click)="closeAssignmentModal()">Cancel</button>
        <button mat-raised-button color="primary" (click)="submitAssignments()" [disabled]="assigning">
          <mat-spinner *ngIf="assigning" diameter="20"></mat-spinner>
          <mat-icon *ngIf="!assigning">save</mat-icon>
          {{ assigning ? 'Assigning...' : 'Save Assignments' }}
        </button>
      </mat-card-actions>
    </mat-card>
  </div>
</ng-container>

<!-- Stage Update Modal -->
<ng-container *ngIf="selectedStageOrder">
  <div class="modal-overlay" (click)="closeStageUpdateModal()">
    <mat-card class="stage-update-modal" (click)="$event.stopPropagation()">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>{{ stageIcons[selectedStage] }}</mat-icon>
          Update {{ selectedStage | titlecase }} - {{ selectedStageOrder.workOrderNumber }}
        </mat-card-title>
      </mat-card-header>
      
      <mat-card-content>
        <form [formGroup]="stageUpdateForm">
          <div class="update-form-row">
            <mat-form-field appearance="outline">
              <mat-label>Status</mat-label>
              <mat-select formControlName="status">
                <mat-option value="not-started">Not Started</mat-option>
                <mat-option value="in-progress">In Progress</mat-option>
                <mat-option value="completed">Completed</mat-option>
                <mat-option value="on-hold">On Hold</mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Jamah Weight (g)</mat-label>
              <input matInput type="number" formControlName="jamahWeight" step="0.01">
            </mat-form-field>
          </div>

          <div class="update-form-row">
            <mat-form-field appearance="outline">
              <mat-label>Sorting Issue</mat-label>
              <input matInput type="number" formControlName="sortingIssue" step="0.01">
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Sorting Jamah</mat-label>
              <input matInput type="number" formControlName="sortingJamah" step="0.01">
            </mat-form-field>
          </div>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Notes</mat-label>
            <textarea matInput formControlName="notes" rows="3" placeholder="Add notes..."></textarea>
          </mat-form-field>

          <mat-checkbox formControlName="approved">Approved</mat-checkbox>
        </form>
      </mat-card-content>
      
      <mat-card-actions>
        <button mat-button (click)="closeStageUpdateModal()">Cancel</button>
        <button mat-raised-button color="primary" (click)="submitStageUpdate()" [disabled]="updatingStage || stageUpdateForm.invalid">
          <mat-spinner *ngIf="updatingStage" diameter="20"></mat-spinner>
          <mat-icon *ngIf="!updatingStage">save</mat-icon>
          {{ updatingStage ? 'Updating...' : 'Update Stage' }}
        </button>
      </mat-card-actions>
    </mat-card>
  </div>
</ng-container>
